# promt: /analyze specifications/registration_api_v1.md save result to specifications/audit_v1_report.md
_____________
# Аудит требований: API Регистрации Пользователей v1.4

**Дата аудита:** 2026-02-03
**Аудитор:** QA Architect (AI)
**Домен:** Mobile/Backend — User Registration
**Статус:** ⛔ Требуется доработка перед разработкой

---
## Executive Summary

Спецификация содержит **5 Blocker** и **6 Critical** дефектов, блокирующих начало разработки и тестирования. Основные проблемы:

1. **Противоречие JSON-примера и таблицы полей** — поле `nickname` в примере отсутствует в контракте
2. **Пример пароля нарушает собственные правила** — `Alex_2026!` содержит имя пользователя
3. **Отсутствует описание Response** — невозможно написать тесты
4. **Нет поля phone для SMS OTP** — заявлена отправка SMS, но телефон не запрашивается
5. **Отсутствуют коды ошибок и NFR**

---
## 1. Таблица Аудита Требований

### Blocker (5)

| # | Слой | Проблема | Рекомендация |
|---|------|----------|--------------|
| 1 | Contract | **Противоречие JSON ↔ таблица:** поле `nickname` есть в примере, но отсутствует в контракте | Добавить `nickname` в таблицу или удалить из примера |
| 2 | Security | **Невалидный пример:** пароль `Alex_2026!` содержит имя `Alex`, нарушая бизнес-правило #3 | Заменить на `"password": "Qwerty_2026!"` |
| 3 | Contract | **Нет Response:** отсутствует описание успешного ответа (HTTP code, body schema) | Добавить секцию Response |
| 4 | Logic | **SMS без phone:** OTP по SMS заявлен, но поле `phone` не запрашивается | Добавить поле `phone` или сменить канал на email |
| 5 | Contract | **Нет Error Responses:** не описаны коды ошибок 400/409/422/500 | Добавить таблицу Error Codes |

### Critical (6)

| # | Слой | Проблема | Рекомендация |
|---|------|----------|--------------|
| 6 | Validation | **Нечёткие правила пароля:** сколько цифр/спецсимволов минимум? Какие символы? | Указать: "мин. 1 цифра, 1 спецсимвол из `!@#$%^&*()-_=+`" |
| 7 | Validation | **Неполные ограничения email:** какой стандарт? Допускаются ли `+` alias? Max длина? | RFC 5322, max 254 символа |
| 8 | Validation | **Нет min для full_name:** только max 100. Пустая строка допустима? | Добавить min 2 символа |
| 9 | Security | **Нет Rate Limiting:** публичный endpoint без защиты от спама | Max 5 регистраций/IP/час |
| 10 | Security | **PII в логах:** email и full_name — персональные данные (GDPR/152-ФЗ) | Маскировать: `a***@example.com` |
| 11 | Idempotency | **Retry behaviour:** что при повторной отправке того же запроса? | Возвращать 409 Conflict |

### Normal (3)

| # | Слой | Проблема | Рекомендация |
|---|------|----------|--------------|
| 12 | Validation | **Правило "части имени":** case-sensitive? минимальная длина подстроки? | Case-insensitive, подстроки 3+ символов |
| 13 | NFR | **Нет NFR:** latency, RPS, timeout не указаны | p99 < 500ms, 100 RPS |
| 14 | Versioning | **Нет Changelog:** версия 1.4, но история изменений отсутствует | Добавить секцию Changelog |

### Low (1)

| # | Слой | Проблема | Рекомендация |
|---|------|----------|--------------|
| 15 | UX | **full_name vs first/last:** одно поле усложняет персонализацию | Рассмотреть разделение полей |

---
## 2. Диаграмма обнаруженных противоречий

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОТИВОРЕЧИЯ В СПЕЦИФИКАЦИИ                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Таблица полей          ≠        Пример JSON                    │
│  ─────────────                   ────────────                   │
│  email ✓                         email ✓                        │
│  password ✓                      password ✓                     │
│  full_name ✓                     full_name ✓                    │
│  (отсутствует)          ⚠️        nickname ← ОТКУДА?            │
│  phone (отсутствует)    ⚠️        (нужен для SMS OTP!)          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Бизнес-правило #3      ≠        Пример пароля                  │
│  ──────────────────              ──────────────                 │
│  "ЗАПРЕЩЕНО использо-            password: "Alex_2026!"         │
│   вать части имени"              full_name: "Alex Kid"          │
│                         ⚠️        "Alex" ⊂ пароль = НАРУШЕНИЕ   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Бизнес-правило #2      ≠        Контракт                       │
│  ──────────────────              ────────                       │
│  "Отправляет SMS        ⚠️        Поле phone НЕ ЗАПРАШИВАЕТСЯ   │
│   с OTP кодом"                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
---
## 3. Вопросы к Product Owner / Аналитику

### Бизнес-логика

1. **Поле nickname:** Это обязательное поле или опечатка в примере? Если обязательное — какие ограничения (длина, уникальность, допустимые символы)?

2. **Канал OTP:** SMS требует номер телефона, которого нет в контракте. Варианты:
   - Добавить обязательное поле `phone`
   - Отправлять OTP на email
   - Убрать 2FA из scope v1.4

3. **Статус аккаунта после регистрации:** Аккаунт сразу активен или требует подтверждения OTP? Что происходит, если OTP не введён в течение X минут?

4. **Повторная регистрация:** Если email уже существует, но OTP не подтверждён — разрешаем перерегистрацию или возвращаем ошибку?

### Техника / Безопасность
5. **Rate Limiting:** Какие лимиты на регистрацию? По IP? По email-домену? Нужен ли CAPTCHA после N неудачных попыток?

6. **OTP параметры:**
   - Длина кода (4/6 цифр)?
   - Время жизни (5 мин / 15 мин)?
   - Количество попыток ввода?

7. **Допустимые спецсимволы в пароле:** Полный список? Поддерживается ли Unicode в пароле (например, emoji)?

8. **Алгоритм проверки "частей имени":**
   - Минимальная длина подстроки для проверки?
   - Case-sensitive?
   - Проверяем ли транслитерацию (Алексей → Alexey)?

### UX / Интеграции

9. **Email confirmation:** Помимо SMS OTP, нужна ли верификация email (double opt-in)?

10. **Ошибки валидации:** Возвращаем все ошибки сразу или первую найденную? Формат поля `errors` в ответе?

---
## 4. Недостающие секции (рекомендуемый шаблон)

```markdown
## Response (Success)
**HTTP 201 Created**
| Поле | Тип | Описание |
|------|-----|----------|
| user_id | string (UUID) | Идентификатор созданного пользователя |
| status | string | Статус аккаунта: "pending_verification" |
| otp_sent_to | string | Маскированный номер телефона: +7***99 |

## Error Responses
| HTTP Code | Error Code | Описание |
|-----------|------------|----------|
| 400 | INVALID_EMAIL | Невалидный формат email |
| 400 | WEAK_PASSWORD | Пароль не соответствует требованиям |
| 400 | PASSWORD_CONTAINS_PII | Пароль содержит части имени/email |
| 409 | EMAIL_EXISTS | Email уже зарегистрирован |
| 422 | VALIDATION_ERROR | Общая ошибка валидации (см. details) |
| 429 | RATE_LIMITED | Превышен лимит запросов |
| 500 | INTERNAL_ERROR | Внутренняя ошибка сервера |

## Non-Functional Requirements
- **Latency:** p99 < 500ms
- **Rate Limit:** 5 запросов в минуту с одного IP
- **SMS Provider Timeout:** 10 секунд
```
---
## 5. Self-Check

- [x] **Completeness:** Все секции чек-листа проверены
- [x] **Prioritization:** Проблемы отсортированы (5 Blocker → 6 Critical → 4 Normal/Low)
- [x] **Actionable:** Каждая проблема имеет конкретную рекомендацию
- [x] **Questions:** Вопросы сгруппированы по категориям (Бизнес/Техника/UX)

---

## Заключение
**Рекомендация:** Спецификация **НЕ ГОТОВА** для передачи в разработку.

Необходимо устранить 5 Blocker-дефектов до начала implementation:
1. Синхронизировать пример JSON с таблицей полей
2. Исправить невалидный пример пароля
3. Добавить описание Response
4. Решить вопрос с phone/SMS
5. Добавить Error Responses

После исправления Blocker-ов рекомендуется провести повторный аудит.
