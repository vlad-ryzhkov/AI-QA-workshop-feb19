# Спецификация: User Registration API v3

## Эндпоинт

`POST /api/v1/users/register` — создание аккаунта в статусе `PENDING`.

## Бизнес-логика (Business Rules)

1. **Уникальность:** Email и Phone должны быть уникальны в системе.
2. **2FA Flow:** Успешный запрос возвращает `verification_token`. Система отправляет 6-значный OTP-код через SMS. Для подтверждения регистрации использовать эндпоинт `POST /api/v1/users/verify` (см. Спецификацию OTP).
3. **Безопасность пароля:**
   - 8–64 символа.
   - Обязательно: заглавная буква, цифра, спецсимвол.
   - **Запрещено (PII Check):** Использование полных слов (токенов) из `full_name` или email (часть до `@`). Разделители слов: точка, пробел, дефис.
4. **Сбой SMS-шлюза:** Если SMS-шлюз недоступен, запрос завершается с кодом `503 SERVICE_UNAVAILABLE`, запись в БД не создаётся (транзакция откатывается).

## Схема данных (Request & Response)

| Поле        | Тип    | Обязательно | Валидация                                                              |
|-------------|--------|-------------|------------------------------------------------------------------------|
| `email`     | string | Да          | RFC 5321 (lowercase), max 254 символа                                  |
| `phone`     | string | Да          | E.164 (только цифры и `+`), min 8, max 16 символов                    |
| `password`  | string | Да          | См. Правила безопасности                                               |
| `full_name` | string | Да          | 2–100 символов, Unicode-буквы, дефисы и одиночные пробелы (не в начале/конце) |

**Успешный ответ (201 Created):**
```json
{
  "verification_token": "jwt_token_here",
  "expires_at": "2026-02-18T22:30:00Z"
}
```

**Формат ошибки (4xx/5xx):**
```json
{"code": "ERROR_CODE", "message": "Human readable text", "field": "field_name"}
```

## Пример запроса (Эталон)

```json
{
  "email": "alex.kid@example.com",
  "phone": "+79991234567",
  "password": "Safe_Password_2026",
  "full_name": "Alex Kideer"
}
```

## Коды ошибок

| HTTP | Code                  | Описание                                                  |
|------|-----------------------|-----------------------------------------------------------|
| 400  | VALIDATION_ERROR      | Ошибка валидации поля (формат, длина, правила пароля)     |
| 409  | CONFLICT              | Email или телефон уже зарегистрированы                    |
| 500  | INTERNAL_ERROR        | Внутренняя ошибка сервера                                 |
| 503  | SERVICE_UNAVAILABLE   | SMS-шлюз недоступен. Транзакция откатана, запись не создана |

## Security & Logging

- **Транспорт:** Только TLS 1.2+. HTTP-запросы отклоняются.
- **Логирование:** Поле `password` должно маскироваться или исключаться из логов приложения.

## Исключено из скоупа тестирования (Test Scope Reduction)

Следующие аспекты **не тестируются** на уровне этого эндпоинта:

| Сценарий | Владелец | Что тестируем вместо |
|---|---|---|
| **Валидация форматов** (`email`, `phone`, `full_name`): Regex, спецсимволы | Middleware (Zod/Pydantic) | Только наличие поля: отсутствие → 400 |
| **Уникальность (Race Condition)**: параллельные запросы с одним email/phone | Unique Index в БД | Только 409 при конфликте (последовательные запросы) |
| **Логика PII (подстроки, токены)**: комбинации "имя в пароле" | Unit-тесты shared-library | Только базовый happy/sad path на уровне API |
| **Гарантия доставки SMS**: факт получения OTP пользователем | Notification Service | Только 201 при успешной постановке в очередь; 503 при недоступности шлюза |
| **Граничные значения длин** (напр. 101 символ в `full_name`) | Уровень БД | — |
